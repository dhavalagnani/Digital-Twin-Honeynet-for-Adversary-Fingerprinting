# Digital Twin Honeynet - HAProxy Configuration
# Traffic redirection between honeypot and production servers

global
    # Global settings
    daemon
    maxconn 4096
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    
    # Security settings
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11

defaults
    # Default settings for all sections
    log global
    mode tcp
    option tcplog
    option dontlognull
    option redispatch
    retries 3
    timeout connect 5000
    timeout client 50000
    timeout server 50000
    timeout check 2000
    
    # Health check settings
    option tcp-check
    tcp-check connect

# Frontend for incoming SSH connections
frontend honeynet_ssh_frontend
    bind *:22
    mode tcp
    default_backend honeypot_backend
    
    # ACL for whitelisted IPs (legitimate traffic)
    acl whitelisted_ip src 192.168.1.0/24
    acl whitelisted_ip src 10.0.0.0/8
    acl whitelisted_ip src 172.16.0.0/12
    
    # ACL for known legitimate users
    acl legitimate_user hdr_reg(host) -i production-server
    acl legitimate_user hdr_reg(host) -i admin-server
    
    # Use honeypot for non-whitelisted IPs (suspicious traffic)
    use_backend honeypot_backend if !whitelisted_ip
    
    # Use production for whitelisted IPs (legitimate traffic)
    use_backend production_backend if whitelisted_ip
    
    # Logging
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %sslc %sslv %{+Q}[capture.req.hdr(0)] %{+Q}[capture.res.hdr(0)]"
    
    # Capture request headers for analysis
    capture request header Host len 32
    capture request header User-Agent len 64

# Backend for honeypot (Cowrie)
backend honeypot_backend
    mode tcp
    balance roundrobin
    option tcp-check
    
    # Honeypot server (Cowrie)
    server honeypot 127.0.0.1:2222 check inter 5s rise 2 fall 3
    
    # Health check
    option tcp-check
    tcp-check connect port 2222
    
    # Logging
    log global
    
    # Statistics
    stats enable
    stats uri /honeypot-stats
    stats refresh 10s
    stats auth admin:secure_password_2024

# Backend for production server
backend production_backend
    mode tcp
    balance roundrobin
    option tcp-check
    
    # Production server
    server production 127.0.0.1:2223 check inter 5s rise 2 fall 3
    
    # Health check
    option tcp-check
    tcp-check connect port 2223
    
    # Logging
    log global
    
    # Statistics
    stats enable
    stats uri /production-stats
    stats refresh 10s
    stats auth admin:secure_password_2024

# Frontend for HTTP/HTTPS traffic (if needed)
frontend honeynet_http_frontend
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/honeynet.pem
    mode http
    default_backend honeypot_http_backend
    
    # ACL for whitelisted IPs
    acl whitelisted_ip src 192.168.1.0/24
    acl whitelisted_ip src 10.0.0.0/8
    acl whitelisted_ip src 172.16.0.0/12
    
    # Use honeypot for non-whitelisted IPs
    use_backend honeypot_http_backend if !whitelisted_ip
    
    # Use production for whitelisted IPs
    use_backend production_http_backend if whitelisted_ip
    
    # Logging
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %sslc %sslv %{+Q}[capture.req.hdr(0)] %{+Q}[capture.res.hdr(0)]"
    
    # Capture headers
    capture request header Host len 32
    capture request header User-Agent len 64
    capture request header Referer len 64

# Backend for honeypot HTTP
backend honeypot_http_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    
    # Honeypot web server
    server honeypot_web 127.0.0.1:8080 check inter 5s rise 2 fall 3
    
    # Logging
    log global

# Backend for production HTTP
backend production_http_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    
    # Production web server
    server production_web 127.0.0.1:8081 check inter 5s rise 2 fall 3
    
    # Logging
    log global

# Statistics page
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:secure_password_2024
    stats admin if TRUE
    
    # Logging
    log global

# Logging configuration
log /dev/log local0 info
log /dev/log local1 notice 